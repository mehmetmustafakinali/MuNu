<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Munu | Akıllı Veresiye</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #6366f1;
            --sidebar-width: 260px;
            --bg-light: #f8fafc;
            --text-dark: #1e293b;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
        }

        /* Sidebar Design */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: #0f172a;
            color: #94a3b8;
            padding-top: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #1e293b;
        }

        /* LOGO ALANI (Sadece Resim) */
        .sidebar-brand-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            padding: 20px 10px;
            border-bottom: 1px solid #1e293b;
        }

        .nav-link {
            color: #94a3b8;
            padding: 14px 25px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: flex;
            align-items: center;
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link.active {
            background: #1e293b;
            color: #fff;
            border-right: 3px solid var(--primary-color);
        }

        .nav-link i {
            width: 25px;
            margin-right: 10px;
            font-size: 1.1rem;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 30px;
        }

        .section-view {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }

        .section-view.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Login Screen */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Cards & Tables */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            background: #fff;
        }

        .table thead th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            color: #64748b;
            background-color: #f1f5f9;
            border-bottom: none;
        }

        /* Logout Area */
        .logout-area {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid #1e293b;
        }

        .btn-logout {
            width: 100%;
            text-align: left;
            color: #ef4444;
            background: transparent;
            border: none;
            padding: 10px;
            transition: 0.2s;
            border-radius: 6px;
        }

        .btn-logout:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Brand Text Footer (Logonun yanı hariç yer) */
        .brand-footer {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 900;
            color: rgba(255, 255, 255, 0.1);
            letter-spacing: 5px;
            margin-bottom: 10px;
            pointer-events: none;
        }

        /* Custom Badges */
        .badge-soft-danger {
            background-color: #fef2f2;
            color: #ef4444;
        }

        .badge-soft-success {
            background-color: #f0fdf4;
            color: #22c55e;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: 0.3s;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>

<body>

    <div id="loginScreen">
        <div class="card p-4 shadow-lg" style="width: 380px;">
            <div class="text-center mb-4">
                <svg width="130" height="130" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"
                    class="mb-3">
                    <circle cx="50" cy="50" r="46" stroke="#6366f1" stroke-width="3" />
                    <path d="M50 12 A38 38 0 1 1 49.9 12" stroke="#6366f1" stroke-width="2" stroke-linecap="round" />
                    <text x="50" y="70" font-family="serif" font-weight="bold" font-size="65" text-anchor="middle"
                        fill="#6366f1">$</text>
                    <line x1="42" y1="15" x2="42" y2="85" stroke="#6366f1" stroke-width="3" stroke-linecap="round" />
                    <line x1="58" y1="15" x2="58" y2="85" stroke="#6366f1" stroke-width="3" stroke-linecap="round" />
                </svg>

                <h3 class="fw-bold text-dark">Giriş Yap</h3>
                <p class="text-muted small">Personel Yönetim Paneli</p>
            </div>
            <div>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="loginUser" value="admin" placeholder="Kullanıcı Adı">
                    <label>Kullanıcı Adı</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" value="1234" placeholder="Şifre">
                    <label>Şifre</label>
                </div>
                <div class="mb-3">
                    <label class="small text-muted mb-1 ms-1">Giriş Yetkisi</label>
                    <select class="form-select" id="roleSelect">
                        <option value="admin">Yönetici (Tam Yetki)</option>
                        <option value="staff">Personel (Kısıtlı)</option>
                    </select>
                </div>
                <button class="btn btn-primary w-100 py-2 fw-bold" onclick="app.login()">Panele Git <i
                        class="fa-solid fa-arrow-right ms-2"></i></button>
            </div>
        </div>
    </div>

    <div id="appContainer" style="display:none;">

        <nav class="sidebar" id="sidebar">
            <div class="sidebar-brand-container">
                <svg width="100" height="100" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="46" stroke="#ffffff" stroke-width="3" />
                    <text x="50" y="70" font-family="serif" font-weight="bold" font-size="65" text-anchor="middle"
                        fill="#ffffff">$</text>
                    <line x1="42" y1="15" x2="42" y2="85" stroke="#ffffff" stroke-width="3" stroke-linecap="round" />
                    <line x1="58" y1="15" x2="58" y2="85" stroke="#ffffff" stroke-width="3" stroke-linecap="round" />
                </svg>
            </div>
            <div class="nav-link active" onclick="app.nav('dashboard')">
                <i class="fa-solid fa-grid-2"></i> Panel
            </div>
            <div class="nav-link" onclick="app.nav('customers')">
                <i class="fa-solid fa-users"></i> Müşteriler
            </div>
            <div class="nav-link" onclick="app.nav('transactions')">
                <i class="fa-solid fa-money-bill-transfer"></i> İşlemler
            </div>
            <div class="nav-link" onclick="app.nav('stock')">
                <i class="fa-solid fa-boxes-stacked"></i> Stok Yönetimi
            </div>

            <div class="mt-4 mb-2 ps-4 text-uppercase small fw-bold text-muted admin-only" style="font-size: 0.7rem;">
                Yönetim</div>
            <div class="nav-link admin-only" onclick="app.nav('reports')">
                <i class="fa-solid fa-chart-pie"></i> Raporlar
            </div>
            <div class="nav-link admin-only" onclick="app.nav('users')">
                <i class="fa-solid fa-user-shield"></i> Personel Yönetimi
            </div>
            <div class="nav-link admin-only" onclick="app.nav('settings')">
                <i class="fa-solid fa-sliders"></i> Ayarlar
            </div>

            <div class="logout-area">
                <div class="brand-footer">MUNU</div>
                <button class="btn-logout" onclick="app.logout()">
                    <i class="fa-solid fa-power-off me-2"></i> Güvenli Çıkış
                </button>
            </div>
        </nav>

        <div class="main-content">
            <div class="d-flex justify-content-between align-items-center mb-5">
                <div class="d-flex align-items-center">
                    <button class="btn btn-light d-md-none me-3"
                        onclick="document.getElementById('sidebar').classList.toggle('show')">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                    <div>
                        <h4 id="pageTitle" class="fw-bold m-0">Genel Bakış</h4>
                        <small class="text-muted" id="currentDateDisplay">Bugün: ...</small>
                    </div>
                </div>

                <div class="d-flex align-items-center bg-white p-2 rounded-pill shadow-sm pe-3">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=6366f1&color=fff" class="rounded-circle"
                        width="40">
                    <div class="ms-3 lh-1 me-3">
                        <span class="d-block fw-bold small" id="headerUsername">Admin</span>
                        <span class="d-block text-success small" style="font-size: 0.7rem;">● Online</span>
                    </div>
                    <button class="btn btn-sm btn-light text-danger border rounded-circle"
                        style="width: 32px; height: 32px;" onclick="app.logout()" title="Çıkış Yap">
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                </div>
            </div>

            <div id="view-dashboard" class="section-view active">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card h-100 p-4 border-start border-4 border-primary">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <p class="text-muted small text-uppercase fw-bold mb-1">Toplam Alacak</p>
                                    <h2 class="fw-bold text-primary mb-0" id="dash-total-debt">0 ₺</h2>
                                </div>
                                <div class="bg-primary bg-opacity-10 p-3 rounded-circle text-primary">
                                    <i class="fa-solid fa-wallet fa-lg"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 p-4 border-start border-4 border-warning">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <p class="text-muted small text-uppercase fw-bold mb-1">Kritik Stok</p>
                                    <h2 class="fw-bold text-warning mb-0" id="dash-stock-count">0 Ürün</h2>
                                </div>
                                <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning">
                                    <i class="fa-solid fa-triangle-exclamation fa-lg"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 p-4 border-start border-4 border-success">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <p class="text-muted small text-uppercase fw-bold mb-1">Aktif Müşteri</p>
                                    <h2 class="fw-bold text-success mb-0" id="dash-cust-count">0</h2>
                                </div>
                                <div class="bg-success bg-opacity-10 p-3 rounded-circle text-success">
                                    <i class="fa-solid fa-users fa-lg"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-8">
                        <div class="card p-4">
                            <h6 class="fw-bold mb-4">Finansal Akış (Son 6 Ay)</h6>
                            <canvas id="mainChart" height="120"></canvas>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card p-4 h-100">
                            <h6 class="fw-bold mb-3">Son İşlemler</h6>
                            <div id="dash-recent-list" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-customers" class="section-view">
                <div class="d-flex justify-content-between mb-4">
                    <div class="input-group w-50">
                        <span class="input-group-text bg-white"><i class="fa-solid fa-search"></i></span>
                        <input type="text" class="form-control border-start-0 ps-0"
                            placeholder="Müşteri adı ile ara...">
                    </div>
                    <button class="btn btn-primary px-4" onclick="ui.openModal('modalCustomer')"><i
                            class="fa-solid fa-plus me-2"></i>Müşteri Ekle</button>
                </div>
                <div class="card overflow-hidden">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4">Müşteri</th>
                                <th>Telefon</th>
                                <th>Bakiye</th>
                                <th>Durum</th>
                                <th class="text-end pe-4">İşlem</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-transactions" class="section-view">
                <div class="d-flex justify-content-end mb-4 gap-2">
                    <button class="btn btn-danger" onclick="ui.openModal('modalTransaction', 'debt')"><i
                            class="fa-solid fa-minus me-2"></i>Borç Ekle</button>
                    <button class="btn btn-success" onclick="ui.openModal('modalTransaction', 'payment')"><i
                            class="fa-solid fa-plus me-2"></i>Tahsilat Yap</button>
                </div>
                <div class="card overflow-hidden">
                    <table class="table table-striped align-middle mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4">Tarih</th>
                                <th>Müşteri</th>
                                <th>Tür</th>
                                <th>Tutar</th>
                                <th>Açıklama</th>
                                <th>Personel</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-stock" class="section-view">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="m-0 fw-bold">Ürün Listesi</h5>
                    <button class="btn btn-dark" onclick="ui.openModal('modalStock')">+ Yeni Ürün</button>
                </div>
                <div class="card overflow-hidden">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4">Kod</th>
                                <th>Ürün Adı</th>
                                <th>Stok</th>
                                <th>Birim Fiyat</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-users" class="section-view">
                <div
                    class="alert alert-primary border-0 bg-primary bg-opacity-10 text-primary d-flex align-items-center">
                    <i class="fa-solid fa-shield-halved me-2 fa-lg"></i>
                    <div>Bu alan sadece Yöneticiler içindir. Çalışan ekleyip silebilirsiniz.</div>
                </div>

                <button class="btn btn-primary mb-4" onclick="ui.openModal('modalUser')">+ Yeni Personel Ekle</button>

                <div class="card overflow-hidden">
                    <table class="table align-middle mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4">Kullanıcı Adı</th>
                                <th>Rolü</th>
                                <th>Eklenme Tarihi</th>
                                <th class="text-end pe-4">İşlem</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-reports" class="section-view">
                <h4 class="fw-bold mb-3">Rapor Merkezi</h4>
                <div class="row">
                    <div class="col-md-7">
                        <div class="card p-0">
                            <div class="card-header bg-white py-3">
                                <h6 class="m-0 fw-bold text-danger"><i class="fa-solid fa-fire me-2"></i>En Borçlu 5
                                    Müşteri</h6>
                            </div>
                            <ul class="list-group list-group-flush" id="report-debtors-list"></ul>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="card p-3 bg-light border-0">
                            <h6>İpucu</h6>
                            <p class="small text-muted m-0">Müşteri listesindeki isimlere tıklayarak detaylı hesap
                                ekstresine ulaşabilirsiniz.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-settings" class="section-view">
                <div class="alert alert-warning d-flex align-items-center mb-4">
                    <i class="fa-solid fa-user-gear fa-2x me-3"></i>
                    <div>
                        <strong>Yönetici Paneli:</strong> Bu ekrandan tüm personele toplu mesaj gönderebilir ve sistem
                        yetkilerini yönetebilirsiniz.
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-7">
                        <div class="card p-4 mb-4 border-0 shadow-sm">
                            <h5 class="fw-bold mb-3"><i class="fa-solid fa-bullhorn text-warning me-2"></i>Personel
                                Duyuru & Görevler</h5>
                            <div class="mb-3">
                                <label class="form-label text-muted small">Günün Mesajı / Atanacak Görevler</label>
                                <textarea id="inpAnnouncement" class="form-control" rows="4"
                                    placeholder="Örn: Arkadaşlar bugün saat 14:00'te kasa sayımı yapılacak..."></textarea>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-primary" onclick="app.saveSettings()"><i
                                        class="fa-solid fa-paper-plane me-2"></i>Personele İlet</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="card p-4 border-0 shadow-sm">
                            <h5 class="fw-bold mb-3"><i class="fa-solid fa-lock text-primary me-2"></i>Yetki Kontrolü
                            </h5>
                            <p class="text-muted small mb-3">Personelin yapabileceği işlemleri buradan
                                kısıtlayabilirsiniz.</p>

                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="permStock" checked>
                                <label class="form-check-label fw-bold">Stok Ekleme İzni</label>
                                <div class="small text-muted">Personel yeni ürün girişi yapabilir.</div>
                            </div>

                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="permDelete">
                                <label class="form-check-label fw-bold">Kayıt Silme İzni</label>
                                <div class="small text-muted">Hatalı işlemleri silme yetkisi ver.</div>
                            </div>

                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="permReport">
                                <label class="form-check-label fw-bold">Rapor Görüntüleme</label>
                                <div class="small text-muted">Personel finansal raporları görebilir.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="modalCustomer" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Yeni Müşteri</h5><button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="inpCustName" class="form-control mb-3" placeholder="Ad Soyad">
                    <input type="text" id="inpCustPhone" class="form-control" placeholder="Telefon (5XX...)">
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="app.addCustomer()">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalCustDetail" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 id="detailTitle" class="fw-bold">...</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div
                        class="d-flex justify-content-between align-items-center mb-4 p-3 bg-white border rounded shadow-sm">
                        <div>
                            <small class="text-muted text-uppercase fw-bold">Toplam Borç</small>
                            <h2 class="text-danger fw-bold m-0" id="detailBalance">0 ₺</h2>
                        </div>
                        <button class="btn btn-outline-dark btn-sm" onclick="window.print()"><i
                                class="fa-solid fa-print me-2"></i>Yazdır</button>
                    </div>
                    <h6 class="text-muted border-bottom pb-2">Hesap Hareketleri</h6>
                    <table class="table table-sm detail-table mt-2">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>İşlem</th>
                                <th>Tutar</th>
                                <th>Açıklama</th>
                            </tr>
                        </thead>
                        <tbody id="detailTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalTransaction" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="transTitle">İşlem Ekle</h5><button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="small text-muted">Müşteri Seçin</label>
                    <select id="inpTransCust" class="form-select mb-3"></select>
                    <label class="small text-muted">Tutar (TL)</label>
                    <input type="number" id="inpTransAmount" class="form-control mb-3" placeholder="0.00">
                    <label class="small text-muted">Açıklama</label>
                    <input type="text" id="inpTransDesc" class="form-control mb-3" placeholder="Not ekleyin...">
                    <label class="small text-muted">Tarih</label>
                    <input type="date" id="inpTransDate" class="form-control">
                    <input type="hidden" id="inpTransType">
                </div>
                <div class="modal-footer"><button id="btnTransSave" class="btn btn-primary"
                        onclick="app.addTransaction()">İşlemi Onayla</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalStock" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Ürün Ekle</h5><button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="inpStockName" class="form-control mb-2" placeholder="Ürün Adı">
                    <input type="number" id="inpStockQty" class="form-control mb-2" placeholder="Stok Adedi">
                    <input type="number" id="inpStockPrice" class="form-control mb-2" placeholder="Birim Fiyat">
                </div>
                <div class="modal-footer"><button class="btn btn-dark" onclick="app.addStock()">Kaydet</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalUser" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Yeni Çalışan</h5><button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="inpUser" class="form-control mb-3" placeholder="Kullanıcı Adı">
                    <select id="inpRole" class="form-select mb-3">
                        <option value="staff">Personel (Kısıtlı Yetki)</option>
                        <option value="admin">Yönetici (Tam Yetki)</option>
                    </select>
                    <div class="alert alert-info py-2"><small>Varsayılan şifre: <b>1234</b></small></div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="app.addUser()">Oluştur</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const db = {
            currentUser: null,
            users: [
                { user: "admin", role: "admin", date: "2023-01-01" },
                { user: "kasiyer1", role: "staff", date: "2024-05-15" }
            ],
            customers: [
                { id: 1, name: "Ahmet Yılmaz", phone: "555-0001", balance: 1500 },
                { id: 2, name: "Ayşe Demir", phone: "555-0002", balance: 450 },
                { id: 3, name: "Mehmet Öz", phone: "555-0003", balance: 2300 },
                { id: 4, name: "Fatma Kaya", phone: "555-0004", balance: 80 }
            ],
            transactions: [
                { id: 101, date: "2024-12-25", customer: "Ahmet Yılmaz", type: "debt", amount: 1500, desc: "Aylık Alışveriş", user: "admin" }
            ],
            stocks: [
                { id: 1, name: "Çaykur Rize 1kg", qty: 45, price: 180 },
                { id: 2, name: "Torku Şeker 5kg", qty: 3, price: 210 }
            ]
        };

        const app = {
            init: () => {
                ui.renderCustomers();
                ui.renderTransactions();
                ui.renderStocks();
                ui.renderUsers();
                ui.renderReports();
                ui.updateDashboard();
                ui.renderChart();
                const today = new Date().toLocaleDateString('tr-TR', { year: 'numeric', month: 'long', day: 'numeric' });
                document.getElementById('currentDateDisplay').innerText = today;
                document.getElementById('headerUsername').innerText = db.currentUser.user;
                document.getElementById('inpTransDate').valueAsDate = new Date();
            },

            login: () => {
                const user = document.getElementById('loginUser').value;
                const role = document.getElementById('roleSelect').value;
                db.currentUser = { user: user, role: role };

                if (role === 'staff') {
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                } else {
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex');
                }

                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                app.init();
            },

            logout: () => {
                db.currentUser = null;
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('loginUser').value = "";
            },

            nav: (pageId) => {
                document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
                event.currentTarget.classList.add('active');
                document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
                document.getElementById('view-' + pageId).classList.add('active');

                const titles = {
                    dashboard: "Genel Bakış", customers: "Müşteri Listesi", transactions: "İşlem Geçmişi",
                    stock: "Stok Yönetimi", reports: "Rapor Merkezi", users: "Personel Yönetimi",
                    settings: "Sistem Ayarları & Yönetim"
                };
                document.getElementById('pageTitle').innerText = titles[pageId];
            },

            addCustomer: () => {
                const name = document.getElementById('inpCustName').value;
                if (!name) return alert("İsim gerekli");
                db.customers.push({ id: Date.now(), name: name, phone: document.getElementById('inpCustPhone').value, balance: 0 });
                ui.renderCustomers();
                bootstrap.Modal.getInstance(document.getElementById('modalCustomer')).hide();
                document.getElementById('inpCustName').value = "";
            },

            addTransaction: () => {
                const custName = document.getElementById('inpTransCust').value;
                const amount = parseFloat(document.getElementById('inpTransAmount').value);
                const type = document.getElementById('inpTransType').value;
                const customer = db.customers.find(c => c.name === custName);
                if (!customer) { alert("Lütfen önce listeden bir müşteri seçiniz!"); return; }
                if (!amount || amount <= 0) return alert("Geçerli bir tutar giriniz");

                if (type === 'payment') {
                    if (amount > customer.balance) { alert(`HATA: Müşterinin toplam borcu ${customer.balance} TL. Daha fazla tahsilat yapılamaz!`); return; }
                    customer.balance -= amount;
                } else {
                    customer.balance += amount;
                }

                db.transactions.unshift({
                    id: Date.now(),
                    date: document.getElementById('inpTransDate').value,
                    customer: custName,
                    type: type,
                    amount: amount,
                    desc: document.getElementById('inpTransDesc').value,
                    user: db.currentUser.user
                });

                ui.renderTransactions();
                ui.renderCustomers();
                ui.renderReports();
                ui.updateDashboard();
                document.getElementById('inpTransAmount').value = "";
                document.getElementById('inpTransDesc').value = "";
                bootstrap.Modal.getInstance(document.getElementById('modalTransaction')).hide();
            },

            addStock: () => {
                const name = document.getElementById('inpStockName').value;
                const qty = parseInt(document.getElementById('inpStockQty').value);
                const price = document.getElementById('inpStockPrice').value;
                if (!name) return alert("Ürün adı giriniz");
                db.stocks.push({ id: Date.now(), name: name, qty: qty, price: price });
                ui.renderStocks();
                ui.updateDashboard();
                bootstrap.Modal.getInstance(document.getElementById('modalStock')).hide();
            },

            addUser: () => {
                const user = document.getElementById('inpUser').value;
                const role = document.getElementById('inpRole').value;
                if (!user) return alert("Kullanıcı adı giriniz");
                db.users.push({ user: user, role: role, date: new Date().toISOString().split('T')[0] });
                ui.renderUsers();
                bootstrap.Modal.getInstance(document.getElementById('modalUser')).hide();
                document.getElementById('inpUser').value = "";
            },

            deleteUser: (username) => {
                if (username === 'admin') return alert("Yönetici silinemez!");
                if (confirm(username + " adlı personeli silmek istediğine emin misin?")) {
                    db.users = db.users.filter(u => u.user !== username);
                    ui.renderUsers();
                }
            },

            saveSettings: () => {
                const msg = document.getElementById('inpAnnouncement').value;
                if (!msg) return alert("Lütfen bir mesaj yazın.");
                alert("Başarılı! Mesaj tüm personele iletildi ve yetkiler güncellendi.");
            }
        };

        const ui = {
            renderCustomers: () => {
                const tbody = document.getElementById('customerTableBody');
                tbody.innerHTML = "";
                const select = document.getElementById('inpTransCust');
                select.innerHTML = "";
                db.customers.forEach(c => {
                    const row = `<tr>
                        <td class="ps-4 fw-bold text-primary" style="cursor:pointer" onclick="ui.showDetail(${c.id})">${c.name}</td>
                        <td>${c.phone}</td>
                        <td class="${c.balance > 0 ? 'text-danger fw-bold' : 'text-success'}">${c.balance} ₺</td>
                        <td><span class="badge ${c.balance > 0 ? 'badge-soft-danger' : 'badge-soft-success'}">${c.balance > 0 ? 'Borçlu' : 'Temiz'}</span></td>
                        <td class="text-end pe-4"><button class="btn btn-sm btn-outline-secondary" onclick="ui.showDetail(${c.id})">Detay</button></td>
                    </tr>`;
                    tbody.innerHTML += row;
                    const opt = document.createElement('option');
                    opt.value = c.name; opt.innerText = c.name;
                    select.appendChild(opt);
                });
            },

            showDetail: (custId) => {
                const customer = db.customers.find(c => c.id === custId);
                const transactions = db.transactions.filter(t => t.customer === customer.name);
                document.getElementById('detailTitle').innerText = customer.name;
                document.getElementById('detailBalance').innerText = customer.balance + " ₺";
                const tbody = document.getElementById('detailTableBody');
                tbody.innerHTML = "";
                if (transactions.length === 0) tbody.innerHTML = "<tr><td colspan='4' class='text-center text-muted'>Kayıt yok.</td></tr>";
                transactions.forEach(t => {
                    tbody.innerHTML += `<tr>
                        <td>${t.date}</td>
                        <td><span class="badge ${t.type === 'debt' ? 'bg-danger' : 'bg-success'}">${t.type === 'debt' ? 'Borç' : 'Tahsilat'}</span></td>
                        <td class="fw-bold">${t.amount} ₺</td>
                        <td>${t.desc}</td>
                    </tr>`;
                });
                new bootstrap.Modal(document.getElementById('modalCustDetail')).show();
            },

            renderTransactions: () => {
                const tbody = document.getElementById('transactionTableBody');
                const recentList = document.getElementById('dash-recent-list');
                tbody.innerHTML = "";
                recentList.innerHTML = "";
                db.transactions.forEach((t, i) => {
                    tbody.innerHTML += `<tr>
                        <td class="ps-4">${t.date}</td>
                        <td>${t.customer}</td>
                        <td><span class="badge ${t.type === 'debt' ? 'bg-danger' : 'bg-success'}">${t.type === 'debt' ? 'Veresiye' : 'Tahsilat'}</span></td>
                        <td class="fw-bold">${t.amount} ₺</td>
                        <td>${t.desc}</td>
                        <td><small class="text-muted">${t.user}</small></td>
                    </tr>`;
                    if (i < 5) {
                        const icon = t.type === 'debt' ? '<i class="fa-solid fa-arrow-up text-danger"></i>' : '<i class="fa-solid fa-arrow-down text-success"></i>';
                        recentList.innerHTML += `<div class="list-group-item d-flex justify-content-between align-items-center border-0 border-bottom px-0"><div class="d-flex align-items-center"><div class="me-3">${icon}</div><div><div class="fw-bold text-dark">${t.customer}</div><div class="small text-muted">${t.desc}</div></div></div><div class="fw-bold ${t.type === 'debt' ? 'text-danger' : 'text-success'}">${t.amount}₺</div></div>`;
                    }
                });
            },

            renderStocks: () => {
                const tbody = document.getElementById('stockTableBody');
                tbody.innerHTML = "";
                db.stocks.forEach(s => {
                    let badge = 'bg-success'; let txt = 'Yeterli';
                    if (s.qty < 5) { badge = 'bg-danger'; txt = 'Kritik'; }
                    tbody.innerHTML += `<tr>
                        <td class="ps-4 text-muted">UR-${s.id}</td>
                        <td class="fw-bold">${s.name}</td>
                        <td>${s.qty}</td>
                        <td>${s.price} ₺</td>
                        <td><span class="badge ${badge}">${txt}</span></td>
                    </tr>`;
                });
            },

            renderUsers: () => {
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = "";
                db.users.forEach(u => {
                    let deleteBtn = '';
                    if (u.user === 'admin') {
                        deleteBtn = `<button class="btn btn-sm btn-secondary disabled" style="opacity:0.5; cursor:not-allowed"><i class="fa-solid fa-lock"></i></button>`;
                    } else {
                        deleteBtn = `<button class="btn btn-sm btn-outline-danger" onclick="app.deleteUser('${u.user}')">Sil</button>`;
                    }
                    tbody.innerHTML += `<tr>
                        <td class="ps-4 fw-bold"><i class="fa-solid fa-user me-2 text-secondary"></i>${u.user}</td>
                        <td><span class="badge bg-${u.role === 'admin' ? 'dark' : 'secondary'} text-uppercase" style="font-size:0.7rem">${u.role}</span></td>
                        <td>${u.date}</td>
                        <td class="text-end pe-4">${deleteBtn}</td>
                    </tr>`;
                });
            },

            renderReports: () => {
                const list = document.getElementById('report-debtors-list');
                list.innerHTML = "";
                const sortedCustomers = [...db.customers].sort((a, b) => b.balance - a.balance);
                const top5 = sortedCustomers.slice(0, 5);
                if (top5.length === 0 || top5[0].balance === 0) { list.innerHTML = "<div class='p-3 text-muted'>Henüz borçlu müşteri yok.</div>"; return; }
                top5.forEach((c, index) => {
                    if (c.balance > 0) {
                        list.innerHTML += `<button onclick="ui.showDetail(${c.id})" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3"><div class="d-flex align-items-center"><span class="badge bg-danger rounded-pill me-3">${index + 1}</span><div><h6 class="m-0 fw-bold text-dark">${c.name}</h6><small class="text-muted"><i class="fa-solid fa-phone me-1"></i>${c.phone}</small></div></div><span class="fs-5 fw-bold text-danger">${c.balance} ₺</span></button>`;
                    }
                });
            },

            updateDashboard: () => {
                const total = db.customers.reduce((acc, c) => acc + c.balance, 0);
                document.getElementById('dash-total-debt').innerText = total + " ₺";
                const critical = db.stocks.filter(s => s.qty < 5).length;
                document.getElementById('dash-stock-count').innerText = critical + " Ürün";
                document.getElementById('dash-cust-count').innerText = db.customers.length;
            },

            openModal: (modalId, type = null) => {
                const myModal = new bootstrap.Modal(document.getElementById(modalId));
                if (modalId === 'modalTransaction') {
                    document.getElementById('transTitle').innerText = type === 'debt' ? 'Borç Ekle (Veresiye)' : 'Tahsilat Al';
                    document.getElementById('inpTransType').value = type;
                    const btn = document.getElementById('btnTransSave');
                    if (type === 'payment') { btn.className = 'btn btn-success'; btn.innerText = 'Ödemeyi Onayla'; }
                    else { btn.className = 'btn btn-danger'; btn.innerText = 'Borcu Kaydet'; }
                }
                myModal.show();
            },

            renderChart: () => {
                const chartStatus = Chart.getChart("mainChart");
                if (chartStatus != undefined) { chartStatus.destroy(); }
                const ctx = document.getElementById('mainChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Tem', 'Ağu', 'Eyl', 'Eki', 'Kas', 'Ara'],
                        datasets: [{ label: 'Aylık Borçlanma', data: [1500, 2100, 1800, 2400, 1900, 2500], borderColor: '#6366f1', backgroundColor: 'rgba(99, 102, 241, 0.1)', fill: true, tension: 0.4 }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
            }
        };
    </script>
</body>

</html>